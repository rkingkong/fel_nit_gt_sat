<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Invoice Form View Extension for FEL -->
    <record id="view_move_form_fel" model="ir.ui.view">
        <field name="name">account.move.form.fel</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">

            <!-- Add FEL buttons to button box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_send_fel" string="Send to FEL" type="object" class="oe_stat_button" icon="fa-send"
                        modifiers="{'invisible': ['|', ('can_send_fel', '=', False), ('fel_status', 'in', ['certified', 'sending'])]}"
                        groups="fel_nit_gt_sat.group_fel_user">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Send to</span><span class="o_stat_text">FEL</span>
                    </div>
                </button>
                <button name="action_view_fel_document" string="FEL Document" type="object" class="oe_stat_button" icon="fa-file-text-o"
                        modifiers="{'invisible': [('fel_document_id', '=', False)]}"
                        groups="fel_nit_gt_sat.group_fel_user">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">FEL</span><span class="o_stat_text">Document</span>
                    </div>
                </button>
                <button name="retry_fel" string="Retry FEL" type="object" class="oe_stat_button" icon="fa-refresh"
                        modifiers="{'invisible': [('fel_status', '!=', 'error')]}"
                        groups="fel_nit_gt_sat.group_fel_user">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Retry</span><span class="o_stat_text">FEL</span>
                    </div>
                </button>
            </xpath>

            <!-- Add FEL fields to accounting info tab -->
            <xpath expr="//group[@name='accounting_info_group']" position="inside">
                <group string="FEL Information" modifiers="{'invisible': [('requires_fel', '=', False)]}"
                       groups="fel_nit_gt_sat.group_fel_user">
                    <field name="fel_status" widget="badge"
                           decoration-success="fel_status=='certified'"
                           decoration-danger="fel_status=='error'"
                           decoration-warning="fel_status=='cancelled'"
                           decoration-info="fel_status in ('sending', 'generating')"/>
                    <field name="fel_document_type_id"
                           modifiers="{'readonly': [('fel_status', 'in', ['certified', 'sending'])]}"
                           options="{'no_create_edit': True}"/>
                    <field name="fel_uuid" readonly="1" modifiers="{'invisible': [('fel_uuid', '=', False)]}"/>
                    <field name="fel_series" readonly="1" modifiers="{'invisible': [('fel_series', '=', False)]}"/>
                    <field name="fel_number" readonly="1" modifiers="{'invisible': [('fel_number', '=', False)]}"/>
                    <field name="fel_certification_date" readonly="1" modifiers="{'invisible': [('fel_certification_date', '=', False)]}"/>
                    <field name="customer_nit" readonly="1" modifiers="{'invisible': [('customer_nit', '=', False)]}"/>
                    <field name="customer_tax_regime" readonly="1" modifiers="{'invisible': [('customer_tax_regime', '=', False)]}"/>
                    <field name="requires_fel" invisible="1"/>
                    <field name="can_send_fel" invisible="1"/>
                </group>
            </xpath>

            <!-- Alerts in sheet -->
            <xpath expr="//sheet" position="inside">
                <div class="alert alert-danger" role="alert"
                     modifiers="{'invisible': [('fel_error_message', '=', False)]}"
                     groups="fel_nit_gt_sat.group_fel_user">
                    <strong>FEL Error:</strong>
                    <field name="fel_error_message" readonly="1"/>
                </div>
                <div class="alert alert-success" role="alert"
                     modifiers="{'invisible': [('fel_status', '!=', 'certified')]}"
                     groups="fel_nit_gt_sat.group_fel_user">
                    <strong>FEL Certified:</strong>
                    This invoice has been successfully certified by SAT.
                    <span modifiers="{'invisible': [('fel_uuid', '=', False)]}">
                        UUID: <field name="fel_uuid" readonly="1"/>
                    </span>
                </div>
            </xpath>

        </field>
    </record>

</odoo>
